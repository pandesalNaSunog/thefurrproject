<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="../js/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
    
    <title>Document</title>
</head>
<body>
    

    <script>
        $(document).ready(function(){
        var appointments = $('#appointments');
        var logout = $('#logout');
        var serviceProcessing = $('#service-processing');
        var serviceProcessingList = $('#service-processing-list');
        var addServiceButton = $('#add-service-button');
        var totalAmount = $('#total-amount');
        var total = 0;
        var customServiceInput = $('#custom-service-input');
        var customServicePrice = $('#custom-service-price');
        var customServiceConfirm = $('#custom-service-confirm');
        var confirmInvoice = $('#confirm-invoice');
        var availableDoctors = $('#available-doctors');
        var inputLabProcedure = $('#input-lab-procedure');
        var inputLabPrice = $('#input-lab-procedure-price');
        var confirmLabProcedure = $('#confirm-lab-procedure');
        var labProceduresInvoiceList = $('#lab-procedures-invoice-list');
        var labResultList = $('#lab-result-list');

        
        


        customServiceConfirm.on('click', function(e){
            e.preventDefault();
            addCustomService();
        })
        getApointments();


        addServiceButton.on('click', function(e){
            e.preventDefault();
            getServices();
        })
        logout.on('click', function(){
            logoutFun();
        });


        function getAppointmentLabRequests(appointmentId){
            labResultList.children().remove();
            $.ajax({
                type: 'GET',
                url: 'php/getAppointmentLabRequests.php',
                data: {
                    appointment_id: appointmentId
                },
                success: function(response){
                    console.log(response)
                    var data = JSON.parse(response);
                    $(data).each(function(index, value){
                        if(value.lab_result == ""){
                            labResultList.append(`<tr>
                                                <td>${value.lab_request}</td>
                                                <td>Pending</td>
                                            </tr>`);
                        }else{
                            labResultList.append(`<tr>
                                                <td>${value.lab_request}</td>
                                                <td><a href="../labtechmodule/php/${value.lab_result}"><img src="../labtechmodule/php/${value.lab_result}" style="height: 50px;width: 50px;"></a></td>
                                            </tr>`);
                        }
                        
                    })
                }
            })
        }

        function addCustomService(){
            if(customServiceInput.val() != "" && customServicePrice.val() != ""){
                serviceProcessingList.append(`<tr><td>${customServiceInput.val()}</td><td>${customServicePrice.val()}</td></tr>`);
                total = parseFloat(total) + parseFloat(customServicePrice.val());
                totalAmount.text(total.toFixed(2));
            }
        }
        function getServices(){
            var addServiceDropDown = $('#add-service-dropdown');
            addServiceDropDown.children().remove();
            
            $.ajax({
                type: 'GET',
                url: 'php/getServices.php',
                success: function(response){
                    var data = JSON.parse(response)
                    $(data).each(function(index, value){
                        addServiceDropDown.append(`<li><button value="${index}" class="dropdown-item service-item">${value.service}</button></li>`);
                    })

                    var serviceItem = $('.service-item');
                    serviceItem.on('click', function(e){
                        var thisIndex = $(this).val();
                        e.preventDefault();
                        serviceProcessingList.append(`<tr><td>${data[thisIndex].service}</td><td>${data[thisIndex].price}</td></tr>`)
                        total = parseFloat(total) + parseFloat(data[thisIndex].price);
                        totalAmount.text(total.toFixed(2));
                    })
                }
            })
        }


        function getApointments(){
            $.ajax({
                type: 'GET',
                url: '../vetModule/php/getAppointments.php',
                success: function(response){
                    var data = JSON.parse(response);
                    $(data).each(function(index,value){
                        appointments.append(`
                                            <tr>
                                                <td>${value.client_name}</td>
                                                <td>${value.appointment.concern}</td>
                                                <td>${value.appointment.date}</td>
                                                <td>${value.appointment.time}</td>
                                                <td>
                                                    <div class="d-flex justify-content-center">
                                                        <button data-bs-toggle="modal" data-bs-target="#set-patient-modal" value="${value.appointment.id}" class="fw-bold btn btn-outline-primary ms-2 set-patient" style="border-radius: 50px; padding-left: 20px; padding-right: 20px;">Patient</button>
                                                        <button value="${value.appointment.id}" class="ms-2 fw-bold btn btn-outline-primary cater" data-bs-toggle="modal" data-bs-target="#cater-appointment-modal" style="border-radius: 50px; padding-left: 20px; padding-right: 20px;">View</button>
                                                        <button data-bs-toggle="modal" data-bs-target="#refer-appointment-modal" value="${value.appointment.id}" class="fw-bold btn btn-outline-primary ms-2 refer" style="border-radius: 50px; padding-left: 20px; padding-right: 20px;">Refer</button>
                                                        
                                                        <button data-bs-toggle="modal" data-bs-target="#view-lab-results" value="${value.appointment.id}" class="fw-bold btn btn-outline-primary ms-2 view-lab-results-btn" style="border-radius: 50px; padding-left: 20px; padding-right: 20px;">Lab Results</button>
                                                    </div>
                                                </td>
                                                
                                            </tr>`)
                        if(value.show_view == true){
                            appointments.children().eq(index).children().eq(5).children().eq(0).children().eq(1).show();
                        }else{
                            appointments.children().eq(index).children().eq(5).children().eq(0).children().eq(1).hide();
                        }
                    })
                    var caterAppointment = $('.cater');
                    var referAppointment = $('.refer');
                    var setPatient = $('.set-patient');
                    var viewLabResultsBtn = $('.view-lab-results-btn');

                    viewLabResultsBtn.on('click', function(){
                        var appointmentId = $(this).val()
                        getAppointmentLabRequests(appointmentId);
                    })

                    viewAndCaterAppointment(caterAppointment);
                    referAppointment.on('click', function(){
                        availableDoctors.children().remove();
                        getAvailableDoctors($(this).val());
                    })

                    setPatient.on('click', function(){
                        var appointmentId = $(this).val();
                        var petName = $('#pet-name');
                        var age = $('#age');
                        var breed = $('#breed');
                        var species = $('#species');
                        var weight = $('#weight');
                        
                        var confirm = $('#confirm-pet');


                        confirm.on('click', function(e){
                            e.preventDefault();

                            if(petName.val() != "" && age.val()!= "" && breed.val() != "" && species.val() != "" && weight.val() != ""){
                                var sexValue = $('input[name="sex"]:checked').val();
                                $.ajax({
                                    type: 'POST',
                                    url: 'php/insertPet.php',
                                    data: {
                                        appointment_id: appointmentId,
                                        pet_name: petName.val(),
                                        age: age.val(),
                                        breed: breed.val(),
                                        species: species.val(),
                                        weight: weight.val(),
                                        sex: sexValue
                                    },
                                    success: function(response){
                                        location.reload();
                                    }
                                })
                            }
                        })
                    })
                }
            })
        }

        function getAvailableDoctors(id){
            
            $.ajax({
                type: 'POST',
                url: 'php/getAvailableDoctors.php',
                data: {
                    appointment_id: id
                },
                success: function(response){
                    var data = JSON.parse(response);

                    $(data).each(function(index, value){
                        availableDoctors.append(`<button value="${value.doctor_id}" class="btn btn-outline-primary fw-bold mt-2 referred-doctor" style="border-radius: 50px; width: 100%">${value.name}</button>`);
                    })

                    var referredDoctor = $('.referred-doctor');

                    referredDoctor.on('click', function(){
                        referClientToAnotherDoctor($(this).val(), id,);
                    })
                }
            })
        }



        function referClientToAnotherDoctor(doctorId, appointmentId){
            $.ajax({
                type: 'POST',
                url: 'php/refer.php',
                data: {
                    doctor_id: doctorId,
                    appointment_id: appointmentId,
                },
                success: function(response){
                    if(response = 'ok'){
                        location.reload();
                    }
                }
            })
        }

        function logoutFun(){
            $.ajax({
                type: 'GET',
                url: '../vetModule/php/vetLogout.php',
                success: function(response){
                    if(response == 'index.html'){
                        window.location.replace(response);
                    }
                }
            })
        }

        function viewAndCaterAppointment(caterAppointment){
            caterAppointment.on('click', function(e){
                total = 0;
                totalAmount.text("");
                var thisCaterAppointment = $(this);
                serviceProcessingList.children().remove();
                getClientNameAndCode(thisCaterAppointment);
                getLabRequests(thisCaterAppointment);
            })
        }

        function getLabRequests(thisCaterAppointment){
            $.ajax({
                type: 'POST',
                url: 'php/getClientLabRequests.php',
                data: {
                    appointment_id: thisCaterAppointment.val()
                },
                success: function(response){
                    var data = JSON.parse(response);
                    labProceduresInvoiceList.children().remove();
                    $(data).each(function(index, value){
                        
                        
                        labProceduresInvoiceList.append(`<tr><td>${value.lab_request}</td><td>${value.lab_request_price}</td></tr>`);
                        
                        total = parseFloat(total) + parseFloat(value.lab_request_price);
                        
                    })
                    totalAmount.text(total.toFixed(2));
                }
            })
        }

        function getClientNameAndCode(thisCaterAppointment){
            $.ajax({
                type: 'POST',
                url: '../vetModule/php/getClientDetails.php',
                data: {
                    appointment_id: thisCaterAppointment.val(),
                },
                success: function(response){
                    var data = JSON.parse(response);
                    serviceProcessing.children('p').remove();
                    serviceProcessing.prepend(`<p class="lh-base fw-bold fs-5">
                                                    <span class="fs-5 lead">
                                                        Client Name: 
                                                    </span>${data.name}<br>
                                                    <span id="client-code-modal" class="fs-5 lead">
                                                        Client Code: 
                                                    </span>${data.client_code}<br>
                                                    <span class="fs-5 lead">Pet Name: </span><span clss="fw-normal fs-5">${data.pet_name}</span> 
                                                </p>`);
                    var clientId = data.client_id;
                    var petId = data.pet_id;
                    console.log(petId);

                    confirmLabProcedure.on('click', function(e){
                        e.preventDefault();

                        if(inputLabProcedure.val() != "" && inputLabPrice.val() != ""){
                            $.ajax({
                                type: 'POST',
                                url: 'php/submitLabRequest.php',
                                data:{
                                    appointment_id: thisCaterAppointment.val(),
                                    pet_id: petId,
                                    client_id: clientId,
                                    lab_request: inputLabProcedure.val(),
                                    price: inputLabPrice.val(),
                                },
                                success: function(response){
                                    var data = JSON.parse(response);
                                    labProceduresInvoiceList.append(`<tr><td>${data.lab_request}</td><td>${data.lab_request_price}</td></tr>`);
                                    total = parseFloat(total) + parseFloat(inputLabPrice.val());
                                    totalAmount.text(total.toFixed(2));
                                }
                            })
                        }
                    })

                    confirmInvoice.on('click', function(e){
                        e.preventDefault();

                        if(serviceProcessingList.children().length != 0){
                            var services = [];
                            var prices = [];
                            serviceProcessingList.children().each(function(index, value){
                                var serviceText = $(this).children().first().text();
                                var pricesText = $(this).children().eq(1).text();
                                services.push(serviceText);
                                prices.push(pricesText);
                            })

                            labProceduresInvoiceList.children().each(function(index, value){
                                var requestText = $(this).children().first().text();
                                var priceText = $(this).children().eq(1).text();
                                services.push(requestText);
                                prices.push(priceText);
                            })

                            $.ajax({
                                type: 'POST',
                                url: 'php/createInvoice.php',
                                data:{
                                    services: services,
                                    pet_id: petId,
                                    prices: prices,
                                    total: total,
                                    client_id: clientId,
                                    appointment_id: thisCaterAppointment.val()
                                },
                                success: function(response){
                                    if(response == 'ok'){
                                        location.reload();
                                    }
                                }
                            })
                        }else{
                            alert('Invoice is empty.');
                        }
                    })
                }
            })
        }
    })
    </script>





    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg text-light bg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                Doctor's Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navMenu">
                <ul class="navbar-nav mb-2 mb-lg-0 ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Appointments</a> 
                    </li>
                    <li class="nav-item">
                        <a id="logout" class="nav-link" href="#">Log Out</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- End of Navigation -->

    <!-- List of Appointments Section -->
    <section id="list-of-appointments">
        <div class="container px-5">
            <div class="rounded-4 shadow card mt-5">
                <div class="card-header">
                    <h3 class="fw-bold">Appointments</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped text-center">
                            <thead>
                                <th scope="col">Client Name</th>
                                <th scope="col">Concern</th>
                                <th scope="col">Date</th>
                                <th scope="col">Time</th>
                                <th scope="col">Action</th>
                                
                            </thead>
                            <tbody id="appointments">
                                    
                            </tbody>
                        </table>   
                    </div>
                </div>  
            </div>
        </div>
    </section>
    <!-- End of List of Appointments -->



    <!-- Cater Appointment Modal -->
    <section class="cater-appointment">
        <div class="modal fade" id="cater-appointment-modal" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-scrollable modal-xl">
                <div class="modal-content">
                    <div class="container">
                        <div class="modal-header">
                            <div class="modal-title">
                                <img src="../images/thefurrproject.PNG" class="img-fluid" alt="">
                            </div>
                        </div>
                        <div class="modal-body" id="service-processing">

                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="fw-bold">Generate Invoice</h3>
                                </div>
                                <div class="card-body">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="fw-bold">Services</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped">
                                                    <thead>
                                                        <th scope="col">Service</th>
                                                        <th scope="col">Amount</th>
                                                    </thead>
                                                    <tbody id="service-processing-list">
            
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card mt-4">
                                        <div class="card-header">
                                            <h5 class="fw-bold">Laboratory Procedures</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped">
                                                    <thead>
                                                        <th scope="col">Procedure</th>
                                                        <th scope="col">Price</th>
                                                    </thead>
                                                    <tbody id="lab-procedures-invoice-list">
        
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>        
                                </div>
                                
                                <div class="card-footer">
                                    <p><span>Total: </span><span id="total-amount" class="fw-bold fs-5"></span></p>
                                </div>
                            </div>
                        </div>

                        <div class="ms-3">
                            <div class="dropdown mb-3">
                                <button style="border-radius: 50px;" id="add-service-button" class=" btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                                    Add Services
                                </button>
                                <ul class="dropdown-menu" id="add-service-dropdown">
                                </ul>
                            </div>
                            <div class="dropdown mb-3">
                                <button style="border-radius: 50px;" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                                    Add Custom Service
                                </button>
                                <form class="dropdown-menu p-3">
                                    <textarea id="custom-service-input" class="form-control" placeholder="Service"></textarea>
                                    <input id="custom-service-price" type="number" class="form-control mt-3" placeholder="Price">
                                    <button id="custom-service-confirm" class="btn btn-primary mt-3" style="border-radius: 50px">Confirm</button>
                                </form>
                            </div>
                            <div class="dropdown mb-3">
                                <button class="dropdown-toggle btn btn-primary" id="add-laboratory-request" style="border-radius: 50px;" data-bs-toggle="dropdown">
                                    Add Laboratory Request
                                </button>
                                <form class="dropdown-menu p-3">
                                    <textarea id="input-lab-procedure" class="form-control mt-2" placeholder="Laboratory Procedure"></textarea>
                                    <input id="input-lab-procedure-price" type="number" class="form-control mt-2" placeholder="Price">
                                    <button id="confirm-lab-procedure" class="btn btn-primary mt-2" style="border-radius: 50px; width: 100%">Confirm</button>
                                </form>
                            </div>

                            <button id="confirm-invoice" class="btn btn-primary align-self-start mb-3" style="border-radius: 50px">Confirm Invoice</button>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- End of Appointment Modal -->

    <!-- Refer Appointment Modal -->

    <div class="modal fade" id="refer-appointment-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">
                        <img src="../images/thefurrproject.PNG" class="img-fluid">
                    </div>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="available-doctors">
    
                </div>
            </div>
        </div>
    </div>
    <!-- End of Refer Appointment Modal -->


    <!-- Set Patient Modal -->
    <div class="modal fade" id="set-patient-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">
                        <img src="../images/thefurrproject.PNG" class="img-fluid" alt="">
                    </div>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input id="pet-name" type="text" class="form-control mt-2" placeholder="Pet Name">
                    <input id="age" type="number" class="form-control mt-2" placeholder="Age">
                    <input id="breed" type="text" class="form-control mt-2" placeholder="Breed">
                    <input id="species" type="text" class="form-control mt-2" placeholder="Species">
                    <input id="weight"type="text" class="form-control mt-2" placeholder="Weight">

                    <div class="form-check mt-2">
                        <input value="Male" type="radio" name="sex" class="form-check-input" id="male">
                        <label for="male" class="form-check-label">
                            Male
                        </label>
                        
                    </div>
                    <div class="form-check mt-2">
                        <input value="Female" type="radio" name="sex" class="form-check-input" id="female">
                        <label for="male" class="form-check-label">
                            Female
                        </label>
                    </div>
                    <button id="confirm-pet" data-bs-dismiss="modal" class="btn btn-primary mt-2" style="border-radius: 50px; width: 100%">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lab Result Modal -->
    <div class="modal fade" id="view-lab-results">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">
                        <img src="../images/thefurrproject.PNG" class="img-fluid">
                    </div>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th scope="col">Laboratory Request</th>
                                    <th scope="col">Result</th>
                                </tr>
                            </thead>
                            <tbody id="lab-result-list">

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</body>
</html>