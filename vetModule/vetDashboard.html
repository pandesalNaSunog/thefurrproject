<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="../js/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
    
    <title>Document</title>
</head>
<body>
    

    <script>
        $(document).ready(function(){
        var appointments = $('#appointments');
        var logout = $('#logout');
        var serviceProcessing = $('#service-processing');
        var serviceProcessingList = $('#service-processing-list');
        var addServiceButton = $('#add-service-button');
        var totalAmount = $('#total-amount');
        var total = 0;
        var customServiceInput = $('#custom-service-input');
        var customServicePrice = $('#custom-service-price');
        var customServiceConfirm = $('#custom-service-confirm');
        var confirmInvoice = $('#confirm-invoice');
        var availableDoctors = $('#available-doctors');
        


        customServiceConfirm.on('click', function(e){
            e.preventDefault();
            addCustomService();
        })
        getApointments();


        addServiceButton.on('click', function(e){
            e.preventDefault();
            getServices();
        })
        logout.on('click', function(){
            logoutFun();
        });



        function addCustomService(){
            if(customServiceInput.val() != "" && customServicePrice.val() != ""){
                serviceProcessingList.append(`<tr><td>${customServiceInput.val()}</td><td>${customServicePrice.val()}</td></tr>`);
                total = parseFloat(total) + parseFloat(customServicePrice.val());
                totalAmount.text(total.toFixed(2));
            }
        }
        function getServices(){
            var addServiceDropDown = $('#add-service-dropdown');
            addServiceDropDown.children().remove();
            
            $.ajax({
                type: 'GET',
                url: 'php/getServices.php',
                success: function(response){
                    var data = JSON.parse(response)
                    $(data).each(function(index, value){
                        addServiceDropDown.append(`<li><button value="${index}" class="dropdown-item service-item">${value.service}</button></li>`);
                    })

                    var serviceItem = $('.service-item');
                    serviceItem.on('click', function(e){
                        var thisIndex = $(this).val();
                        e.preventDefault();
                        serviceProcessingList.append(`<tr><td>${data[thisIndex].service}</td><td>${data[thisIndex].price}</td></tr>`)
                        total = parseFloat(total) + parseFloat(data[thisIndex].price);
                        totalAmount.text(total.toFixed(2));
                    })
                }
            })
        }


        function getApointments(){
            $.ajax({
                type: 'GET',
                url: '../vetModule/php/getAppointments.php',
                success: function(response){
                    var data = JSON.parse(response);
                    $(data).each(function(index,value){
                        appointments.append(`
                                            <tr>
                                                <td>${value.client_name}</td>
                                                <td>${value.appointment.concern}</td>
                                                <td>${value.appointment.date}</td>
                                                <td>${value.appointment.time}</td>
                                                <td>
                                                    <div class="d-flex justify-content-center">
                                                        <button value="${value.appointment.id}" class="btn btn-primary cater" data-bs-toggle="modal" data-bs-target="#cater-appointment-modal" style="border-radius: 50px; padding-left: 20px; padding-right: 20px;">View</button>
                                                        <button data-bs-toggle="modal" data-bs-target="#refer-appointment-modal" value="${value.appointment.id}" class="btn btn-primary ms-2 refer" style="border-radius: 50px; padding-left: 20px; padding-right: 20px;">Refer</button>
                                                    </div>
                                                </td>
                                            </tr>`)
                    })
                    var caterAppointment = $('.cater');
                    var referAppointment = $('.refer');
                    viewAndCaterAppointment(caterAppointment);
                    referAppointment.on('click', function(){
                        availableDoctors.children().remove();
                        getAvailableDoctors($(this).val());
                    })
                }
            })
        }

        function getAvailableDoctors(id){
            
            $.ajax({
                type: 'POST',
                url: 'php/getAvailableDoctors.php',
                data: {
                    appointment_id: id
                },
                success: function(response){
                    var data = JSON.parse(response);

                    $(data).each(function(index, value){
                        availableDoctors.append(`<button value="${value.doctor_id}" class="btn btn-outline-primary fw-bold mt-2 referred-doctor" style="border-radius: 50px; width: 100%">${value.name}</button>`);
                    })

                    var referredDoctor = $('.referred-doctor');

                    referredDoctor.on('click', function(){
                        referClientToAnotherDoctor($(this).val(), id,);
                    })
                }
            })
        }



        function referClientToAnotherDoctor(doctorId, appointmentId){
            $.ajax({
                type: 'POST',
                url: 'php/refer.php',
                data: {
                    doctor_id: doctorId,
                    appointment_id: appointmentId,
                },
                success: function(response){
                    if(response = 'ok'){
                        location.reload();
                    }
                }
            })
        }

        function logoutFun(){
            $.ajax({
                type: 'GET',
                url: '../vetModule/php/vetLogout.php',
                success: function(response){
                    if(response == 'index.html'){
                        window.location.replace(response);
                    }
                }
            })
        }

        function viewAndCaterAppointment(caterAppointment){
            caterAppointment.on('click', function(e){
                total = 0;
                totalAmount.text("");
                var thisCaterAppointment = $(this);
                serviceProcessingList.children().remove();
                getClientNameAndCode(thisCaterAppointment);
                
            })
        }

        function getClientNameAndCode(thisCaterAppointment){
            $.ajax({
                type: 'POST',
                url: '../vetModule/php/getClientDetails.php',
                data: {
                    appointment_id: thisCaterAppointment.val(),
                },
                success: function(response){
                    console.log(response);
                    var data = JSON.parse(response);
                    serviceProcessing.children('p').remove();
                    serviceProcessing.prepend(`<p class="lh-sm fw-bold fs-3"><span class="fs-5 lead">Name: </span>${data.name}<br><span id="client-code-modal" class="fw-normal fs-5">${data.client_code}</span></p>`);
                    var clientId = data.id;

                    confirmInvoice.on('click', function(e){
                        console.log('clicked');
                        e.preventDefault();

                        if(serviceProcessingList.children().length != 0){
                            var services = [];
                            var prices = [];
                            serviceProcessingList.children().each(function(index, value){
                                var serviceText = $(this).children().first().text();
                                var pricesText = $(this).children().eq(1).text();
                                services.push(serviceText);
                                prices.push(pricesText);
                            })

                            $.ajax({
                                type: 'POST',
                                url: 'php/createInvoice.php',
                                data:{
                                    services: services,
                                    prices: prices,
                                    total: total,
                                    client_id: clientId,
                                    appointment_id: thisCaterAppointment.val()
                                },
                                success: function(response){
                                    if(response == 'ok'){
                                        location.reload();
                                    }
                                }
                            })
                        }else{
                            alert('Invoice is empty.');
                        }
                    })
                }
            })
        }
    })
    </script>





    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg text-light bg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                Doctor's Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navMenu">
                <ul class="navbar-nav mb-2 mb-lg-0 ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Appointments</a> 
                    </li>
                    <li class="nav-item">
                        <a id="logout" class="nav-link" href="#">Log Out</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- End of Navigation -->

    <!-- List of Appointments Section -->
    <section id="list-of-appointments">
        <div class="container">
            <div class="table-responsive">
                <div class="card mt-5">
                    
                        <div class="card-header">
                            <h3 class="fw-bold">Appointments</h3>
                        </div>
                        <table class="table table-striped text-center">
                            <thead>
                                <th scope="col">Client Name</th>
                                <th scope="col">Concern</th>
                                <th scope="col">Date</th>
                                <th scope="col">Time</th>
                                <th scope="col">Action</th>
                                
                            </thead>
                            <tbody id="appointments">
                                
                            </tbody>
                        </table>
                    
                </div>
            </div>
        </div>
    </section>
    <!-- End of List of Appointments -->



    <!-- Cater Appointment Modal -->
    <section class="cater-appointment">
        <div class="modal fade" id="cater-appointment-modal">
            <div class="modal-dialog modal-fullscreen">
                <div class="modal-content">
                    <div class="container">
                        <div class="modal-header">
                            <div class="modal-title">
                                <img src="../images/thefurrproject.PNG" class="img-fluid" alt="">
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="service-processing">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="fw-bold">Generate Invoice</h3>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <th scope="col">Service</th>
                                            <th scope="col">Amount</th>
                                        </thead>
                                        <tbody id="service-processing-list">

                                        </tbody>
                                    </table>
                                </div>
                                <div class="card-footer">
                                    <p><span>Total: </span><span id="total-amount" class="fw-bold fs-5"></span></p>
                                </div>
                            </div>
                        </div>

                        <div class="d-md-flex ms-3">
                            <div class="dropdown">
                                <button style="border-radius: 50px;" id="add-service-button" class="mb-md-5 mb-3 mt-md-2 btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                                    Add Services
                                </button>
                                <ul class="dropdown-menu" id="add-service-dropdown">
                                </ul>
                            </div>
                            <div class="dropdown ms-md-2">
                                <button style="border-radius: 50px;" id="add-service-button" class="mb-md-5 mb-3 mt-md-2 btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                                    Add Custom Service
                                </button>
                                <form class="dropdown-menu p-3">
                                    <textarea id="custom-service-input" class="form-control" placeholder="Service"></textarea>
                                    <input id="custom-service-price" type="number" class="form-control mt-3" placeholder="Price">
                                    <button id="custom-service-confirm" class="btn btn-primary mt-3" style="border-radius: 50px">Confirm</button>
                                </form>
                            </div>

                            <button id="confirm-invoice" class="btn btn-primary align-self-start mt-md-2 ms-md-2" style="border-radius: 50px">Confirm Invoice</button>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- End of Appointment Modal -->

    <!-- Refer Appointment Modal -->

    <div class="modal fade" id="refer-appointment-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">
                        <img src="../images/thefurrproject.PNG" class="img-fluid">
                    </div>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="available-doctors">
    
                </div>
            </div>
        </div>
    </div>
    <!-- End of Refer Appointment Modal -->

    
</body>
</html>