<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/jquery.js">
        
    </script>
    <title>Document</title>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg sticky-top">
        <div class="container">
            <div class="navbar-brand">
                Client Dashboard
            </div>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navMenu">
                <ul class="navbar-nav ms-auto fw-bold">
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            Appointments
                        </a>
                    </li>
                    <li class="nav-item">
                        <div class="dropdown">
                            <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                                Account
                            </a>
                            <ul class="dropdown-menu">
                                <li>
                                    <a href="#" class="dropdown-item" id="logout">
                                        Logout
                                    </a>
                                </li>
                            </ul>
                        </div>
                        
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Logout Script -->

    <script>
        $(document).ready(function(){
            var logout = $('#logout');

            logout.on('click', function(e){
                e.preventDefault();

                $.ajax({
                    type: 'GET',
                    url: 'php/logout.php',
                    success: function(response){
                        if(response == 'index.html'){
                            window.location.replace(response);
                        }
                    }
                })
            })
        })
    </script>
    
    <!-- appointment section -->
    <section id="appointment-section">
        <div class="container px-5">
            <div class="d-lg-flex justify-content-between">
                <div class="col-lg-7 card mt-5 shadow rounded-4">
                    <div class="card-header rounded-bottom rounded-4">
                        <h2 class="fw-bold">List of Appointments</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped text-center">
                                <thead>
                                    <tr>
                                        <th scope="col">Client Name</th>
                                        <th scope="col">Concern</th>
                                        <th scope="col">Attending Vet</th>
                                        <th scope="col">Date</th>
                                        <th scope="col">Time</th>
                                        <th scope="col">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="appointment-list">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
    
                <div class="col-lg-4 shadow card mt-5 rounded-4">
                    <div class="card-header rounded-bottom rounded-4">
                        <h3 class="fw-bold">
                            Today's Appointments
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped text-center">
                                <thead>
                                    <tr>
                                        <th scope="col">Client Name</th>
                                        <th scope="col">Concern</th>
                                        <th scope="col">Attending Vet</th>
                                        <th scope="col">Date</th>
                                        <th scope="col">Time</th>
                                        <th scope="col">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="today-appointment-list">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <button data-bs-toggle="modal" data-bs-target="#appointment-modal" class="mt-5 btn btn-primary fw-bold" style="border-radius: 50px; padding-left: 20px; padding-right: 20px">Book an Appointment</button> 
        </div>
    </section>


    <!-- appointment time schedules -->
    <section id="appointment-time-schedules">
        <div class="container px-5">
            <div class="shadow card my-3 mt-5 rounded-4">
                <div class="card-header rounded-bottom rounded-4">
                    <h3 class="fw-bold">Appointment Schedules</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped text-center">
                            <thead>
                                <tr>
                                    <th scope="col">Time</th>
                                    <th scope="col">Availability</th>
                                </tr>
                            </thead>
                            <tbody id="appointment-time-list">
                            </tbody>
                        </table>
                    </div>
                    
                </div>
            </div>
        </div>
    </section>


    <!-- Appointment Booking Modal -->

    <div class="modal fade" id="appointment-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">
                        <img src="../images/thefurrproject.PNG" class="img-fluid" alt="">
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body fw-bold">
                    Choose Date:
                    <input id="appointment-date" type="date" class="form-control mt-3">
                    <button data-bs-dismiss="modal" id="check-schedules" class="btn btn-primary mt-3" style="width: 100%; border-radius: 50px">Check Schedules</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Choose Doctors Modal -->
    <div class="modal fade" id="choose-doctors-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">
                        <img src="../images/thefurrproject.PNG" class="img-fluid" alt="">
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body fw-bold" id="doctors-list">
                    <p style="color: red">You have already booked this schedule.</p>
                </div>
                <div class="modal-footer">
                    <input type="text" class="form-control" placeholder="Concern" id="concern">
                    <div class="invalid-feedback">
                        Please enter your concern.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointment Booking Script -->
    <script>
        $(document).ready(function(e){
            var appointmentDate = $('#appointment-date');
            var checkSchedules = $('#check-schedules');
            var appointmentTimeList = $('#appointment-time-list');
            var doctorsList = $('#doctors-list');
            var concern = $('#concern');
            var clientId = 0;
            concern.removeClass('is-invalid');
            var appointmentList = $('#appointment-list');
            var clientName = ""
            var todayAppointmentList = $('#today-appointment-list');
            $.ajax({
                type: 'GET',
                url: 'php/getMyAppointments.php',
                success: function(response){
                    var data = JSON.parse(response);
                    console.log(data);
                    $(data).each(function(index,value){
                        if(value.is_today == true){
                            todayAppointmentList.append(`<tr>
                                                    <td>${value.name}</td>
                                                    <td>${value.concern}</td>
                                                    <td>${value.vet}</td>
                                                    <td>${value.date}</td>
                                                    <td>${value.time}</td>
                                                    <td class="fw-bold">${value.status}</td>
                                                </tr>`)
                        }else{
                            appointmentList.append(`<tr>
                                                    <td>${value.name}</td>
                                                    <td>${value.concern}</td>
                                                    <td>${value.vet}</td>
                                                    <td>${value.date}</td>
                                                    <td>${value.time}</td>
                                                    <td class="fw-bold">${value.status}</td>
                                                </tr>`)
                        }
                        
                        clientName = value.name;
                    })
                }
            })

            $.ajax({
                type: 'GET',
                url: 'php/getId.php',
                success: function(response){
                    if(response == 'index.html'){
                        window.location.replace(response);
                    }else{
                        clientId = response;
                    } 
                }
            })

            checkSchedules.on('click', function(e){
                if(appointmentDate.val() != ""){
                    $.ajax({
                        type: 'POST',
                        url: 'php/getAppointmentTimeSchedules.php',
                        data: {
                            date: appointmentDate.val()
                        },
                        success: function(response){
                            console.log(response);
                            if(response == 'invalid'){
                                alert('Invalid Date');
                            }else{
                                var data = JSON.parse(response);
                                appointmentTimeList.children().remove();
                                $(data).each(function(index,value){
                                    if(value.availability != 'Fully Booked!'){
                                        appointmentTimeList.append(`<tr>
                                                                    <td>${value.time}</td>
                                                                    <td>
                                                                        <button data-bs-toggle="modal" data-bs-target="#choose-doctors-modal" style="border-radius: 50px; padding-left: 30px; padding-right: 30px;" class="btn btn-primary mx-auto book" value="${value.date}/${value.time}">Book</button>
                                                                    </td>
                                                                </tr>`);
                                    }
                                    else{
                                        appointmentTimeList.append(`<tr>
                                                                    <td>${value.time}</td>
                                                                    <td>
                                                                        <p class="fw-bold" style="color: red">Fully Booked!</p>
                                                                    </td>
                                                                </tr>`);
                                    }
                                })

                                var book = $('.book');
                                book.on('click', function(e){
                                    var value = $(this).val();
                                    var date = value.split('/')[0];
                                    var time = value.split('/')[1];
                                    doctorsList.children().remove();
                                    $.ajax({
                                        type: 'POST',
                                        url: 'php/getAvailableDoctors.php',
                                        data: {
                                            time: time,
                                            date: date
                                        },
                                        success: function(response){
                                            console.log(response);
                                            if(response != 'already booked by client'){
                                                var data = JSON.parse(response);
                                                concern.show();
                                                $(data).each(function(index,value){
                                                    doctorsList.append(`<button value="${value.id}" data-bs-dismiss="modal" class="btn btn-outline-primary mt-3 fw-bold doctor" style="width: 100%; border-radius: 50px">${value.name}</button>`)
                                                });

                                                var doctor = $('.doctor');

                                                doctor.on('click', function(e){
                                                    var thisDoctor = $(this);
                                                    e.preventDefault();
                                                    if(concern.val() == ""){
                                                        concern.addClass('is-invalid');
                                                    }else{
                                                        $.ajax({
                                                            type: 'POST',
                                                            url: 'php/bookAppointment.php',
                                                            data: {
                                                                client_id: clientId,
                                                                doctor_id: thisDoctor.val(),
                                                                date: date,
                                                                time: time,
                                                                concern: concern.val()
                                                            },
                                                            success: function(response){
                                                                if(response == 'invalid date'){
                                                                    alert('Invalid Date and Time');
                                                                }else{
                                                                    location.reload();
                                                                }
                                                                
                                                            
                                                            }
                                                        })
                                                    }
                                                    
                                                })
                                            }else{
                                                concern.hide();
                                                doctorsList.append(`<p class="fw-bold text-center" style="color: red;">You have already booked this schedule</p>`);
                                            }
                                        }
                                    })
                                })
                            }
                        }
                    })
                }
            })
        })
    </script>
</body>
</html>